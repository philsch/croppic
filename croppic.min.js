(function(k,h){Croppic=function(a,b){this.id=a;this.outputDiv=this.obj=$("#"+a);this.options={uploadUrl:"",uploadData:{},cropUrl:"",cropData:{},outputUrlId:"",imgEyecandy:!0,imgEyecandyOpacity:.2,zoomFactor:10,doubleZoomControls:!0,modal:!1,customUploadButtonId:"",loaderHtml:"",onBeforeImgUpload:null,onImgUploadError:null,onAfterImgUpload:null,onImgDrag:null,onImgZoom:null,onBeforeImgCrop:null,onImgCropError:null,onAfterImgCrop:null};for(i in b)this.options[i]=b[i];this.init()};Croppic.prototype={id:"",imgInitW:0,imgInitH:0,imgW:0,imgH:0,objW:0,objH:0,windowW:0,windowH:$(k).height(),obj:{},outputDiv:{},outputUrlObj:{},img:{},defaultImg:{},croppedImg:{},imgEyecandy:{},form:{},cropControlsUpload:{},cropControlsCrop:{},cropControlZoomMuchIn:{},cropControlZoomMuchOut:{},cropControlZoomIn:{},cropControlZoomOut:{},cropControlCrop:{},cropControlReset:{},cropControlRemoveCroppedImage:{},modal:{},loader:{},init:function(){this.objW=this.obj.width();this.objH=this.obj.height();$.isEmptyObject(this.defaultImg)&&(this.defaultImg=this.obj.find("img"));this.createImgUploadControls();this.bindImgUploadControl()},createImgUploadControls:function(){var a="";""===this.options.customUploadButtonId&&(a='<i class="cropControlUpload"></i>');var b='<i class="cropControlRemoveCroppedImage"></i>';$.isEmptyObject(this.croppedImg)&&(b="");this.outputDiv.append('<div class="cropControls cropControlsUpload"> '+a+b+" </div>");this.cropControlsUpload=this.outputDiv.find(".cropControlsUpload");""===this.options.customUploadButtonId?this.imgUploadControl=this.outputDiv.find(".cropControlUpload"):(this.imgUploadControl=$("#"+this.options.customUploadButtonId),this.imgUploadControl.show());$.isEmptyObject(this.croppedImg)||(this.cropControlRemoveCroppedImage=this.outputDiv.find(".cropControlRemoveCroppedImage"))},bindImgUploadControl:function(){var a=this;a.outputDiv.append('<form class="'+a.id+'_imgUploadForm" style="display: none; visibility: hidden;">  <input type="file" name="img">  </form>');a.form=a.outputDiv.find("."+a.id+"_imgUploadForm");a.imgUploadControl.off("click");a.imgUploadControl.on("click",function(){a.form.find('input[type="file"]').trigger("click")});if(!$.isEmptyObject(a.croppedImg))a.cropControlRemoveCroppedImage.on("click",function(){a.croppedImg.remove();$(this).hide();$.isEmptyObject(a.defaultImg)||a.obj.append(a.defaultImg);""!==a.options.outputUrlId&&$("#"+a.options.outputUrlId).val("")});a.form.find('input[type="file"]').change(function(){a.options.onBeforeImgUpload&&a.options.onBeforeImgUpload.call(a);a.showLoader();a.imgUploadControl.hide();var b=new FormData(a.form[0]),d;for(d in a.options.uploadData)a.options.uploadData.hasOwnProperty(d)&&b.append(d,a.options.uploadData[d]);$.ajax({url:a.options.uploadUrl,data:b,context:h.body,cache:!1,contentType:!1,processData:!1,type:"POST"}).always(function(c){response="object"==typeof c?c:jQuery.parseJSON(c);"success"==response.status&&(a.imgInitW=a.imgW=response.width,a.imgInitH=a.imgH=response.height,a.options.modal&&a.createModal(),$.isEmptyObject(a.croppedImg)||a.croppedImg.remove(),a.imgUrl=response.url,a.obj.append('<img src="'+response.url+'">'),a.initCropper(),a.hideLoader(),a.options.onAfterImgUpload&&a.options.onAfterImgUpload.call(a));"error"==response.status&&(a.options.onImgUploadError&&a.options.onImgUploadError.call(a,response.message),a.obj.append('<p style="width:100%; height:100%; text-align:center; line-height:'+a.objH+'px;">'+response.message+"</p>"),a.hideLoader(),setTimeout(function(){a.reset()},2E3))})})},createModal:function(){var a='<div id="croppicModal"><div id="croppicModalObj" style="width:'+this.objW+"px; height:"+this.objH+"px; margin:0 auto; margin-top:"+(this.windowH/2-this.objH/2)+'px; position: relative;"> </div></div>';$("body").append(a);this.modal=$("#croppicModal");this.obj=$("#croppicModalObj")},destroyModal:function(){this.obj=this.outputDiv;this.modal.remove()},initCropper:function(){this.img=this.obj.find("img");this.img.wrap('<div class="cropImgWrapper" style="overflow:hidden; z-index:1; position:absolute; width:'+this.objW+"px; height:"+this.objH+'px;"></div>');this.createCropControls();this.options.imgEyecandy&&this.createEyecandy();this.initDrag();this.initialScaleImg()},createEyecandy:function(){this.imgEyecandy=this.img.clone();this.imgEyecandy.css({"z-index":"0",opacity:this.options.imgEyecandyOpacity}).appendTo(this.obj)},destroyEyecandy:function(){this.imgEyecandy.remove()},initialScaleImg:function(){this.zoom(-this.imgInitW);this.zoom(40);this.img.css({left:-(this.imgW-this.objW)/2,top:-(this.imgH-this.objH)/2,position:"relative"});this.options.imgEyecandy&&this.imgEyecandy.css({left:-(this.imgW-this.objW)/2,top:-(this.imgH-this.objH)/2,position:"relative"})},createCropControls:function(){var a=this;a.obj.append(a.options.doubleZoomControls?'<div class="cropControls cropControlsCrop"><i class="cropControlZoomMuchIn"></i><i class="cropControlZoomIn"></i><i class="cropControlZoomOut"></i><i class="cropControlZoomMuchOut"></i><i class="cropControlCrop"></i><i class="cropControlReset"></i></div>':'<div class="cropControls cropControlsCrop"><i class="cropControlZoomIn"></i><i class="cropControlZoomOut"></i><i class="cropControlCrop"></i><i class="cropControlReset"></i></div>');a.cropControlsCrop=a.obj.find(".cropControlsCrop");a.options.doubleZoomControls&&(a.cropControlZoomMuchIn=a.cropControlsCrop.find(".cropControlZoomMuchIn"),a.cropControlZoomMuchIn.on("click",function(){a.zoom(10*a.options.zoomFactor)}),a.cropControlZoomMuchOut=a.cropControlsCrop.find(".cropControlZoomMuchOut"),a.cropControlZoomMuchOut.on("click",function(){a.zoom(10*-a.options.zoomFactor)}));a.cropControlZoomIn=a.cropControlsCrop.find(".cropControlZoomIn");a.cropControlZoomIn.on("click",function(){a.zoom(a.options.zoomFactor)});a.cropControlZoomOut=a.cropControlsCrop.find(".cropControlZoomOut");a.cropControlZoomOut.on("click",function(){a.zoom(-a.options.zoomFactor)});a.cropControlCrop=a.cropControlsCrop.find(".cropControlCrop");a.cropControlCrop.on("click",function(){a.crop()});a.cropControlReset=a.cropControlsCrop.find(".cropControlReset");a.cropControlReset.on("click",function(){a.reset()})},initDrag:function(){var a=this;a.img.on("mousedown",function(b){b.preventDefault();var d=a.img.css("z-index"),c=a.img.outerHeight(),f=a.img.outerWidth(),g=a.img.offset().top+c-b.pageY,h=a.img.offset().left+f-b.pageX;a.img.css("z-index",1E3).on("mousemove",function(b){var e=b.pageY+g-c;b=b.pageX+h-f;a.img.offset({top:e,left:b}).on("mouseup",function(){$(this).removeClass("draggable").css("z-index",d)});a.options.imgEyecandy&&a.imgEyecandy.offset({top:e,left:b});0<parseInt(a.img.css("top"))&&(a.img.css("top",0),a.options.imgEyecandy&&a.imgEyecandy.css("top",0));e=-(a.imgH-a.objH);parseInt(a.img.css("top"))<e&&(a.img.css("top",e),a.options.imgEyecandy&&a.imgEyecandy.css("top",e));0<parseInt(a.img.css("left"))&&(a.img.css("left",0),a.options.imgEyecandy&&a.imgEyecandy.css("left",0));e=-(a.imgW-a.objW);parseInt(a.img.css("left"))<e&&(a.img.css("left",e),a.options.imgEyecandy&&a.imgEyecandy.css("left",e));a.options.onImgDrag&&a.options.onImgDrag.call(a)})}).on("mouseup",function(){a.img.off("mousemove")}).on("mouseout",function(){a.img.off("mousemove")})},zoom:function(a){var b=this.imgW/this.imgH,d=this.imgW+a,c=d/b,f=!0;if(d<this.objW||c<this.objH)d-this.objW<c-this.objH?(d=this.objW,c=d/b):(c=this.objH,d=b*c),f=!1;if(d>this.imgInitW||c>this.imgInitH)d-this.imgInitW<c-this.imgInitH?(d=this.imgInitW,c=d/b):(c=this.imgInitH,d=b*c),f=!1;this.imgW=d;this.img.width(d);this.imgH=c;this.img.height(c);b=parseInt(this.img.css("top"))-a/2;a=parseInt(this.img.css("left"))-a/2;0<b&&(b=0);0<a&&(a=0);var g=-(c-this.objH);b<g&&(b=g);g=-(d-this.objW);a<g&&(a=g);f&&this.img.css({top:b,left:a});this.options.imgEyecandy&&(this.imgEyecandy.width(d),this.imgEyecandy.height(c),f&&this.imgEyecandy.css({top:b,left:a}));this.options.onImgZoom&&this.options.onImgZoom.call(this)},crop:function(){var a=this;a.options.onBeforeImgCrop&&a.options.onBeforeImgCrop.call(a);a.cropControlsCrop.hide();a.showLoader();var b={imgUrl:a.imgUrl,imgInitW:a.imgInitW,imgInitH:a.imgInitH,imgW:a.imgW,imgH:a.imgH,imgY1:Math.abs(parseInt(a.img.css("top"))),imgX1:Math.abs(parseInt(a.img.css("left"))),cropH:a.objH,cropW:a.objW},d=new FormData,c;for(c in b)b.hasOwnProperty(c)&&d.append(c,b[c]);for(c in a.options.cropData)a.options.cropData.hasOwnProperty(c)&&d.append(c,a.options.cropData[c]);$.ajax({url:a.options.cropUrl,data:d,context:h.body,cache:!1,contentType:!1,processData:!1,type:"POST"}).always(function(b){response="object"==typeof b?b:jQuery.parseJSON(b);"success"==response.status&&(a.imgEyecandy.hide(),a.destroy(),a.obj.append('<img class="croppedImg" src="'+response.url+'">'),""!==a.options.outputUrlId&&$("#"+a.options.outputUrlId).val(response.url),a.croppedImg=a.obj.find(".croppedImg"),a.init(),a.hideLoader());"error"==response.status&&(a.options.onImgCropError&&a.options.onImgCropError.call(a,response.message),a.obj.append('<p style="width:100%; height:100%;>'+response.message+'</p>">'));a.options.onAfterImgCrop&&a.options.onAfterImgCrop.call(a)})},showLoader:function(){this.obj.append(this.options.loaderHtml);this.loader=this.obj.find(".loader")},hideLoader:function(){this.loader.remove()},reset:function(){this.destroy();this.init();$.isEmptyObject(this.croppedImg)||(this.obj.append(this.croppedImg),""!==this.options.outputUrlId&&$("#"+this.options.outputUrlId).val(this.croppedImg.attr("url")))},destroy:function(){this.options.modal&&!$.isEmptyObject(this.modal)&&this.destroyModal();this.options.imgEyecandy&&!$.isEmptyObject(this.imgEyecandy)&&this.destroyEyecandy();$.isEmptyObject(this.cropControlsUpload)||this.cropControlsUpload.remove();$.isEmptyObject(this.cropControlsCrop)||this.cropControlsCrop.remove();$.isEmptyObject(this.loader)||this.loader.remove();$.isEmptyObject(this.form)||this.form.remove();this.obj.html("")}}})(window,document);